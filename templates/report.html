{%- import "macros.html" as macros -%}

<!DOCTYPE html>

<!--
  Generated by akochan-reviewer: https://github.com/Equim-chan/akochan-reviewer
-->

<html lang="{{ lang }}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if lang == "en" %}Replay Examination{% else %}牌譜検討{% endif %}</title>
</head>

<body {% if layout == "horizontal" %} horizontal="1" {% endif %} >
  <h1>{% if lang == "en" %}Replay Examination{% else %}牌譜検討{% endif %}</h1>

  <label><input type="radio" name="style" id="radio_style_v" {% if layout == "vertical" %} checked="true" {% endif %} onclick="toggleStyle()" />vertical</label>
  <label><input type="radio" name="style" id="radio_style_h" {% if layout == "horizontal" %} checked="true" {% endif %} onclick="toggleStyle()" />horizontal</label>

  <details open class="collapse">
    <summary>{% if lang == "en" %}Game Summary{% else %}目次{% endif %}</summary>
    <div class="kyoku-toc">
	  <ol class="kyoku-list">
        {%- for item in kyokus -%}
          <li class="kyoku-item">
            <a href="#kyoku-{{ item.kyoku }}-{{ item.honba }}">
              {%- if lang == "en" -%}
                {{- kyoku_to_string_en(kyoku=item.kyoku, honba=item.honba) -}}
              {%- else -%}
                {{- kyoku_to_string_ja(kyoku=item.kyoku, honba=item.honba) -}}
              {%- endif -%}
            </a>
          </li>
        {%- endfor -%}
      </ol>
      <ol class="end-status-list">
        {%- for item in kyokus -%}
          <li class="end-status-item">
            <span class="end-status">
              {%- for end_status in item.end_status -%}
                {{- macros::render_end_status(end_status=end_status, target_actor=target_actor) -}}
              {%- endfor -%}
            </span>
          </li>
        {%- endfor -%}
      </ol>

	  <ol class="end-score-item">
	  {%- for item in kyokus -%}
		<li>
          <span class="end-score">
          {%- if item.hand_score*100!=0 -%}
		    {{ pretty_round(num=(item.hand_score*100), prec=1) }}%
		  {%- else -%}
			-
		  {%- endif -%}
          </span>
		</li>
		 {%- endfor -%}
      </ol>

    </div>

	<span class="top-score">Overall Score: {{ pretty_round(num=(metadata.score*100), prec=1) }}%</span>
  </details>

  <details class="collapse">
    <summary>Metadata</summary>
    <dl>
      <dt>pt</dt>
      <dd>{{ metadata.pt }}</dd>
      <dt>game length</dt>
      <dd>{{ metadata.game_length }}</dd>
      <dt>actor id</dt>
      <dd>{{ target_actor }}</dd>
      <dt>log id</dt>
      <dd>{{ metadata.log_id | default(value="N/A") | safe }}</dd>
      <dt>loading time</dt>
      <dd>{{ metadata.loading_time }}</dd>
      <dt>review time</dt>
      <dd>{{ metadata.review_time }}</dd>
      <dt>(1 - (problems - tolerated) / reviewed) * 100 = score (v1)</dt>
      <dd>(1 - ({{ metadata.total_problems + metadata.total_tolerated }} - {{ metadata.total_tolerated }}) / {{ metadata.total_reviewed }}) * 100 = {{ pretty_round(num=((1 - metadata.total_problems / metadata.total_reviewed) * 100), prec=2) }}</dd>
      <dt>
        <span id="score-latex">\( \displaystyle 100 \times (\frac{1}{n}\sum_{i=1}^{n} \frac{E_i[actual] - E_i[min]}{E_i[max] - E_i[min]})^2 = score \ \text{(v2)} \)</span>
      </dt>
      <dd>{{ pretty_round(num=(metadata.score*100), prec=3) }}</dd>
      <dt>deviation threshold</dt>
      <dd>{{ metadata.deviation_threshold }}</dd>
      <dt>generated at</dt>
      <dd>{{ now() | date(format="%Y-%m-%d %H:%M:%S") }}</dd>
      <dt>reviewer version</dt>
      <dd>{{ metadata.version }}</dd>
    </dl>
  </details>

	<p class="togglelinks">
	[<a href="javascript:{}" onclick="toggleViewers()" id="buttonViewers">Close Replay Viewers</a>]
	[<a href="javascript:{}" onclick="toggleErrors()" id="buttonErrors">Close Errors</a>]
	[<a href="javascript:{}" onclick="toggleAkosays()" id="buttonAkosays">Hide Akosays</a>]
	</p>

  {%- for item in kyokus -%}
    <section style="z-index: {{ 10 + loop.index0 }}">
      <h1 id="kyoku-{{ item.kyoku }}-{{ item.honba }}" class="kyoku-heading">
        <div class="kyoku-item">
          <a href="#kyoku-{{ item.kyoku }}-{{ item.honba }}" class="chapter">
            {%- if lang == "en" -%}
              {{ kyoku_to_string_en(kyoku=item.kyoku, honba=item.honba) }}
            {%- else -%}
              {{ kyoku_to_string_ja(kyoku=item.kyoku, honba=item.honba) }}
            {%- endif -%}
          </a>
        </div>
        <div class="end-status-item">
          <span class="end-status">
            {%- for end_status in item.end_status -%}
              {{- macros::render_end_status(end_status=end_status, target_actor=target_actor) -}}
            {%- endfor -%}
          </span>
        </div>

		<div class="end-score-item">
          <span class="end-score">
		  {%- if item.hand_score*100!=0 -%}
			({{ pretty_round(num=(item.hand_score*100), prec=1) }}%)
		  {%- else -%}
            
		  {%- endif -%}
          </span>
        </div>
      </h1>

      {%- if splited_logs is defined -%}
        <div class="sticky l-box" style="z-index: {{ 15 + loop.index0 }}" {% if layout == "horizontal" %} horizontal="1" {% endif %} >
          <details {% if item.entries | length != 0 %} open {% endif %} class="collapse replayviewer">
            <summary>{% if lang == "en" %}Replay Viewer{%- else -%}牌譜ビューア{% endif %}</summary>
            <iframe
              src="https://tenhou.net/5/?tw={{ target_actor }}#json={{ splited_logs[loop.index0] | json_encode() }}"
              class="tenhou"
              scrolling="no"
              marginwidth="0"
              marginheight="0"
              frameborder="0"
            ></iframe>
          </details>
        </div>
      {%- endif -%}

      <div class="r-box" {% if layout == "horizontal" %} horizontal="1" {% endif %} >
      {%- if item.entries | length == 0 -%}
      <details class="collapse">
        <summary>
            {%- if lang == "en" -%}
              Turn 0
            {%- else -%}
              0 巡
            {%- endif -%}
        </summary>
      </details>
      {%- endif -%}
      {%- for entry in item.entries -%}
        {%- if entry.acceptance == "disagree" -%}
          <details open class="{{- macros::render_akoface(dropped_ev=entry.dev, dev_threshold=metadata.deviation_threshold) -}}">
		  <div class="akotext">{{- macros::render_akotext(drop=entry.dev, dev=metadata.deviation_threshold, action=entry.expected) -}}</div>
        {%- else -%}
          <details class="collapse">
        {%- endif -%}
          <summary>
            {%- if lang == "en" -%}
              Turn {{ entry.junme }}
            {%- else -%}
              {{ entry.junme }} 巡
            {%- endif -%}
            {%- if entry.acceptance == "disagree" -%}
              &nbsp;&nbsp;&nbsp;❌&nbsp;&nbsp;-{{- pretty_round(num=entry.dev, prec=2) -}}&nbsp;EV
            {%- elif entry.acceptance == "tolerable" -%}
              &nbsp;&nbsp;&nbsp;😐
            {%- endif -%}
          </summary>
          {{- macros::render_tehai_state(entry=entry, target_actor=target_actor) -}}
          <ul>
            <li>
              {% if lang == "en" %}akochan's decision:{% else %}akochan の最善手：{% endif %}
              <ul>
                <li>
                  {{- macros::render_action(action=entry.expected) -}}
                </li>
              </ul>
            </li>
            <li>
              {% if lang == "en" %}Your decision:{% else %}自家：{% endif %}
              <ul>
                <li>
                  {{- macros::render_action(action=entry.actual) -}}
                </li>
              </ul>
            </li>
          </ul>

          {%- if entry.details is defined -%}
            <details>
              <table border="1" cellspacing="0" cellpadding="0" class="stat">
                <thead>
                  <tr>
                    <th></th>
                    <th>
                      {%- if metadata.use_placement_ev -%}
                        {% if lang == "en" %}Placement {% else %}最終順位{%- endif -%}
                      {%- else -%}
                        pt&nbsp;
                      {%- endif -%}
                      {% if lang == "en" %}EV{% else %}期待値{% endif %}
                    </th>
                    <th>{% if lang == "en" %}Deal-in{% else %}放銃率{% endif %} (%)</th>
                    <th>
                      {% if lang == "en" %}Post-Deal-in{% else %}放銃後の{% endif %}
                      {%- if metadata.use_placement_ev -%}
                        {% if lang == "en" %} Placement {% else %}最終順位{% endif %}
                      {%- else -%}
                        &nbsp;pt&nbsp;
                      {%- endif -%}
                      {% if lang == "en" %}EV{%- else -%}期待値{% endif %}
                    </th>
                    <th>
                      {% if lang == "en" %}Tile Passes{% else %}通った後の{% endif %}
                      {%- if metadata.use_placement_ev -%}
                        {% if lang == "en" %} Placement {% else %}最終順位{% endif %}
                      {%- else -%}
                        &nbsp;pt&nbsp;
                      {%- endif -%}
                      {% if lang == "en" %}EV{% else %}期待値{% endif %}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {%- for detail in entry.details -%}
                    <tr>
                      <td>
                        {{- macros::render_action(action=detail.moves) -}}
                      </td>
                      <td>
                        {%- if detail.review.pt_exp_total is number -%}
                          {%- if metadata.use_placement_ev -%}
                            {%- set val = 0 - detail.review.pt_exp_total -%}
                          {%- else -%}
                            {%- set val = detail.review.pt_exp_total -%}
                          {%- endif -%}
                          <span title="{{ val }}">
                            {{- pretty_round(num=val) -}}
                          </span>
                        {%- else -%}
                          N/A
                        {%- endif -%}
                      </td>
                      <td>
                        {%- if detail.review.total_houjuu_hai_prob_now is number -%}
                          <span title="{{ detail.review.total_houjuu_hai_prob_now * 100 }}">
                            {{- pretty_round(num=(detail.review.total_houjuu_hai_prob_now * 100)) -}}
                          </span>
                        {%- else -%}
                          N/A
                        {%- endif -%}
                      </td>
                      <td>
                        {%- if detail.review.total_houjuu_hai_value_now is number -%}
                          {%- if metadata.use_placement_ev -%}
                            {%- set val = 0 - detail.review.total_houjuu_hai_value_now -%}
                          {%- else -%}
                            {%- set val = detail.review.total_houjuu_hai_value_now -%}
                          {%- endif -%}
                          <span title="{{ val }}">
                            {{- pretty_round(num=val) -}}
                          </span>
                        {%- else -%}
                          N/A
                        {%- endif -%}
                      </td>
                      <td>
                        {%- if detail.review.pt_exp_after is number -%}
                          {%- if metadata.use_placement_ev -%}
                            {%- set val = 0 - detail.review.pt_exp_after -%}
                          {%- else -%}
                            {%- set val = detail.review.pt_exp_after -%}
                          {%- endif -%}
                          <span title="{{ val }}">
                            {{- pretty_round(num=val) -}}
                          </span>
                        {%- else -%}
                          N/A
                        {%- endif -%}
                      </td>
                    </tr>
                  {%- endfor -%}
                </tbody>
              </table>
			  [<a href="https://kobalab.net/majiang/dapai.html#{{- macros::make_kobalab_string(entry=entry) -}}" target="_blank">Kobalab (no dora/round)</a>]
            </details>
          {%- endif -%}
        </details>
      {%- endfor -%}
      </div>
    </section>
  {%- endfor -%}

  <script>{%- include "report.js" -%}</script>
  <style>{%- include "report.css" -%}</style>
  {%- include "pai.svg" -%}

  <script>
function toggleAkosays()
{
    
	var elem = document.getElementById("buttonAkosays");
	if(elem.textContent.valueOf() === "Hide Akosays")
	{
		// toggle the elements off
		var elements = document.getElementsByClassName('akotext');
		for (var i = 0; i < elements.length; i++){elements[i].style.display = 'none';}
		var elements = document.getElementsByClassName('akodisagree');
		for (var i = 0; i < elements.length; i++){elements[i].style.backgroundSize = 0;}
		elem.textContent = "Show Akosays";
	}
	else
	{
		// toggle the elements on
		var elements = document.getElementsByClassName('akotext');
		for (var i = 0; i < elements.length; i++){elements[i].style.display = 'block';}
		var elements = document.getElementsByClassName('akodisagree');
		for (var i = 0; i < elements.length; i++){elements[i].style.backgroundSize = null;}
		elem.textContent = "Hide Akosays";
	}	
}

function toggleViewers()
{
	// toggle on and off all the tenhou replay viewers
	var elem = document.getElementById("buttonViewers");
	if(elem.textContent.valueOf() === "Close Replay Viewers")
	{
		var elements = document.getElementsByClassName('replayviewer');
		for (var i = 0; i < elements.length; i++){elements[i].open = false;}
		elem.textContent = "Open Replay Viewers";
	}
	else
	{
		var elements = document.getElementsByClassName('replayviewer');
		for (var i = 0; i < elements.length; i++){elements[i].open = true;}
		elem.textContent = "Close Replay Viewers";
	}
}

function toggleErrors()
{
	// toggle on and off all the red X errors
	var elem = document.getElementById("buttonErrors");
	if(elem.textContent.valueOf() === "Close Errors")
	{
		var elements = document.getElementsByClassName('akodisagree');
		for (var i = 0; i < elements.length; i++){elements[i].open = false;}
		elem.textContent = "Open Errors";
	}
	else
	{
		var elements = document.getElementsByClassName('akodisagree');
		for (var i = 0; i < elements.length; i++){elements[i].open = true;}
		elem.textContent = "Close Errors";
	}
	
}
</script> 

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.querySelector('#score-latex'));"></script>
</body>

</html>
